"use strict";const e=require("electron"),S=require("node:os"),t=require("node:path"),h=require("ali-oss"),d=require("fs"),D="OPEN_LINK",v="GET_DOWNLOADS_PATH",T="OPEN_FILE_DIALOG",L=async(o="")=>{await e.shell.openExternal(o)},m=()=>e.app.getPath("downloads"),R=async(o=e.app.getPath("downloads"))=>{const{filePaths:n}=await e.dialog.showOpenDialog({title:"选择下载位置",properties:["openDirectory","createDirectory"],defaultPath:o});return n},g=()=>{e.ipcMain.handle(D,async(o,n)=>L(n)),e.ipcMain.handle(v,()=>m()),e.ipcMain.handle(T,async(o,...n)=>R(...n)),e.ipcMain.handle("OSS_INIT",(o,...n)=>O(...n)),e.ipcMain.handle("GET_STRAME",async(o,...n)=>y(...n))};let r=null;const y=async(...o)=>{const n=o[0],i=o[1],c=o[2];if(!r)return;const I=await r.getStream(n);return await d.promises.mkdir(i,{recursive:!0}),new Promise((f,l)=>{try{const a=d.createWriteStream(`${i}/${c}`);I.stream.pipe(a),a.on("finish",()=>{console.log(c),f()}),a.on("error",p=>{console.error("ababab",p),l(p)})}catch(a){l(a)}})},O=(...o)=>{const n=JSON.parse(o[0]);r=new h({region:n.region,accessKeyId:n.accessKeyId,accessKeySecret:n.accessKeySecret,bucket:n.bucket,stsToken:n.securityToken})},P=()=>{g()};process.env.DIST_ELECTRON=t.join(__dirname,"..");process.env.DIST=t.join(process.env.DIST_ELECTRON,"../dist");process.env.PUBLIC=process.env.VITE_DEV_SERVER_URL?t.join(process.env.DIST_ELECTRON,"../public"):process.env.DIST;S.release().startsWith("6.1")&&e.app.disableHardwareAcceleration();process.platform==="win32"&&e.app.setAppUserModelId(e.app.getName());e.app.requestSingleInstanceLock()||(e.app.quit(),process.exit(0));let s=null;const w=t.join(__dirname,"../preload/index.js"),E=process.env.VITE_DEV_SERVER_URL,_=t.join(process.env.DIST,"index.html");async function u(){s=new e.BrowserWindow({title:"Main window",icon:t.join(process.env.PUBLIC,"favicon.ico"),webPreferences:{preload:w,nodeIntegration:!0,contextIsolation:!1,webSecurity:!1}}),P(),process.env.VITE_DEV_SERVER_URL?(s.loadURL(E),s.webContents.openDevTools()):s.loadFile(_),s.webContents.on("did-finish-load",()=>{s==null||s.webContents.send("main-process-message",new Date().toLocaleString())}),s.webContents.on("will-navigate",(o,n)=>{o.preventDefault(),e.shell.openExternal(n)})}e.app.whenReady().then(u);e.app.on("window-all-closed",()=>{s=null,process.platform!=="darwin"&&e.app.quit()});e.app.on("second-instance",()=>{s&&(s.isMinimized()&&s.restore(),s.focus())});e.app.on("activate",()=>{const o=e.BrowserWindow.getAllWindows();o.length?o[0].focus():u()});e.ipcMain.handle("open-win",(o,n)=>{const i=new e.BrowserWindow({webPreferences:{preload:w,nodeIntegration:!0,contextIsolation:!1}});process.env.VITE_DEV_SERVER_URL?i.loadURL(`${E}#${n}`):i.loadFile(_,{hash:n})});
